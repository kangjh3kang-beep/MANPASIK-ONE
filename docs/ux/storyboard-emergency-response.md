# 긴급 대응 사용자 여정 스토리보드

**문서번호**: MPK-UX-SB-EMERGENCY-v1.0
**기준**: 사이트맵 v1.1 (/settings/emergency, 푸시 알림)
**Phase**: Phase 3
**최종 갱신**: 2026-02-15

---

## 장면 1: 긴급 대응 설정

### 와이어프레임
```
┌─────────────────────────────┐
│  ◀  긴급 대응 설정           │
├─────────────────────────────┤
│                             │
│ 🚨 긴급 연락처               │
│ ┌─────────────────────────┐ │
│ │ 1. 김영희 (배우자)        │ │
│ │    010-1234-5678    [✏️]  │ │
│ ├─────────────────────────┤ │
│ │ 2. 홍길순 (자녀)          │ │
│ │    010-9876-5432    [✏️]  │ │
│ ├─────────────────────────┤ │
│ │        [+ 연락처 추가]    │ │
│ └─────────────────────────┘ │
│                             │
│ ⚙️ 위험 감지 기준             │
│ ┌─────────────────────────┐ │
│ │ 혈당 상한 경고             │ │
│ │ ├──────────●──────┤      │ │
│ │ 200     250 mg/dL  300   │ │
│ │                         │ │
│ │ 혈당 하한 경고             │ │
│ │ ├───●──────────────┤      │ │
│ │ 40   55 mg/dL      80   │ │
│ │                         │ │
│ │ 혈당 변동폭 경고           │ │
│ │ ├────────●─────────┤      │ │
│ │ 30    50 mg/dL/h    80  │ │
│ │                         │ │
│ │ [기본값으로 초기화]        │ │
│ └─────────────────────────┘ │
│                             │
│ 🚑 119 자동 신고              │
│ ┌─────────────────────────┐ │
│ │ 119 자동 신고 활성화       │ │
│ │                 [━━●]   │ │
│ │                         │ │
│ │ ⚠️ 활성화 시 보호자 무응답  │ │
│ │ 30분 후 자동으로 119에     │ │
│ │ 신고합니다.               │ │
│ └─────────────────────────┘ │
│                             │
│ 🛡️ 안전 모드                 │
│ ┌─────────────────────────┐ │
│ │ ● 일반 모드               │ │
│ │   표준 감지 주기 (15분)    │ │
│ │ ○ 야간 모드               │ │
│ │   수면 중 감도 강화 (5분)  │ │
│ │ ○ 외출 모드               │ │
│ │   GPS 추적 활성화         │ │
│ │ ○ 독거 모드               │ │
│ │   최고 감도 (3분) + 119   │ │
│ └─────────────────────────┘ │
│                             │
│ [  설정 저장  ]              │
└─────────────────────────────┘
```

### 설명
- **긴급 연락처 CRUD**: 긴급 연락처를 추가/수정/삭제할 수 있으며, 우선순위(1순위, 2순위)를 설정한다.
- **위험 감지 기준 슬라이더**: 혈당 상한/하한 경고치와 급격한 변동폭 기준을 슬라이더로 조절한다.
- **119 자동 신고 토글**: 활성화 시 2단계 확인 다이얼로그를 표시하여 오작동을 방지한다.
- **안전 모드**: 일반/야간/외출/독거 4가지 모드로 감지 주기와 대응 강도를 조절한다.

### 119 활성화 확인 다이얼로그
```
┌─────────────────────────────┐
│                             │
│  🚑 119 자동 신고를           │
│  활성화하시겠습니까?          │
│                             │
│  활성화 시:                  │
│  • 위험 감지 후 보호자 무응답 │
│    30분 경과 시 자동 신고     │
│  • 환자 정보와 GPS 위치가    │
│    119에 자동 전송됩니다     │
│  • 오신고 시 책임은 사용자에  │
│    게 있습니다               │
│                             │
│  ☑ 위 내용을 이해하고         │
│    동의합니다                │
│                             │
│  [활성화]     [취소]         │
│                             │
└─────────────────────────────┘
```

### UX 포인트
- 연락처 추가: 연락처 앱 연동 또는 직접 입력
- 슬라이더 조절 시 실시간 프리뷰: "현재 설정 기준 최근 7일간 경고 발생: 2회"
- 119 토글: 2단계 확인 (동의 체크 + 확인 버튼) 후 활성화
- 안전 모드 변경 시: 해당 모드 설명 애니메이션 표시
- NotificationService.UpdateEmergencySettings RPC 호출

### 접근성
- 슬라이더: 접근성 라벨 "혈당 상한 경고, 현재 250밀리그램 퍼 데시리터"
- 119 토글: "119 자동 신고, 현재 비활성화, 스위치 꺼짐"
- 안전 모드: 라디오 버튼 "일반 모드 선택됨, 표준 감지 주기 15분"

### 음성 안내 (TTS)
> "긴급 대응 설정입니다. 긴급 연락처, 위험 감지 기준, 119 자동 신고, 안전 모드를 설정할 수 있습니다."

---

## 장면 2: 이상 감지 알림

### 푸시 알림
```
┌─────────────────────────────┐
│ 🔴 만파식 긴급 알림           │
│                             │
│ 혈당이 위험 수준입니다        │
│ 측정값: 285 mg/dL           │
│ 시각: 14:32                 │
│                             │
│ [확인하기]  [무시]           │
└─────────────────────────────┘
```

### 알림 상세 화면
```
┌─────────────────────────────┐
│  ◀  긴급 알림 상세           │
├─────────────────────────────┤
│                             │
│ 🔴 이상 감지                 │
│                             │
│ 위험 수치                    │
│ ┌─────────────────────────┐ │
│ │ 🩸 혈당: 285 mg/dL       │ │
│ │ 정상 범위: 70~140 mg/dL  │ │
│ │ 경고 기준: 250 mg/dL     │ │
│ │ 초과량: +35 mg/dL        │ │
│ └─────────────────────────┘ │
│                             │
│ 🤖 AI 분석                   │
│ ┌─────────────────────────┐ │
│ │ "식후 급격한 혈당 상승이   │ │
│ │  감지되었습니다. 최근 3시간│ │
│ │  내 120→285로 급등했으며, │ │
│ │  즉시 의료 전문가 상담을   │ │
│ │  권장합니다."             │ │
│ │                         │ │
│ │ 위험도: ████████░░ 높음   │ │
│ └─────────────────────────┘ │
│                             │
│ 📈 최근 24시간 트렌드         │
│ ┌─────────────────────────┐ │
│ │ 300┤              ╱█    │ │
│ │ 250┤ ─ ─ ─ ─ ─ ╱─ ─ ─ │ │
│ │ 200┤           ╱        │ │
│ │ 150┤    ╱╲    ╱         │ │
│ │ 100┤───╱──╲──╱──────── │ │
│ │    └─────────────────── │ │
│ │    00  06  12  14  지금  │ │
│ │ ─── 경고선 (250)         │ │
│ └─────────────────────────┘ │
│                             │
│ 긴급 행동                    │
│ ┌─────────────────────────┐ │
│ │ [📞 보호자에게 전화]       │ │
│ │ [🏥 긴급 진료 예약]        │ │
│ │ [🚑 119 신고]             │ │
│ └─────────────────────────┘ │
│                             │
│ ✅ "괜찮아요" (알림 해제)     │
└─────────────────────────────┘
```

### 설명
- **푸시 알림**: 위험 수치 감지 시 즉시 푸시 알림을 전송한다. Do Not Disturb 모드에서도 우회하여 표시한다.
- **알림 상세**: 위험 수치, AI 분석 코멘트, 최근 24시간 트렌드 차트를 종합적으로 표시한다.
- **긴급 행동 버튼**: 전화 연결, 긴급 진료 예약, 119 신고 3가지 행동을 원터치로 실행한다.
- **"괜찮아요" 버튼**: 본인이 상황을 인지했음을 확인하여 에스컬레이션을 중지한다.

### UX 포인트
- 푸시 알림: 진동 패턴(긴-짧-긴) + 경고음 + 화면 깨움
- 알림 상세 진입 시: 에스컬레이션 타이머 표시 ("보호자 알림까지 2분 47초")
- "괜찮아요" 탭 시: 확인 기록 저장 + 에스컬레이션 중지
- 트렌드 차트: 경고선 이상 구간 빨간색 하이라이트

### 접근성
- 푸시 알림: 진동 + 사운드 + 시각 (다중 감각 알림)
- 위험 수치: 스크린리더 "혈당 285밀리그램 퍼 데시리터, 정상 범위 초과, 위험"
- 긴급 버튼: 최소 56x56dp, 고대비 빨간색 배경
- 차트: "최근 24시간 혈당 트렌드, 14시에 285로 급등"

### 음성 안내 (TTS)
> "긴급 알림입니다. 혈당이 285밀리그램으로 위험 수준입니다. 보호자에게 전화하거나, 긴급 진료를 예약하거나, 119에 신고할 수 있습니다. 괜찮으시면 괜찮아요 버튼을 눌러주세요."

---

## 장면 3: 에스컬레이션 시나리오

### 시나리오 흐름도
```
┌──────────────────────────────────────────────────┐
│                에스컬레이션 타임라인                 │
├──────────────────────────────────────────────────┤
│                                                  │
│  [이상 감지]                                      │
│      │                                           │
│      ▼ 즉시                                      │
│  ┌────────────────────┐                          │
│  │ 1단계: 본인 알림     │                          │
│  │ • 푸시 + 진동 + 소리 │                          │
│  │ • "괜찮아요" 대기     │                          │
│  └─────────┬──────────┘                          │
│            │ 3분 무응답                            │
│            ▼                                     │
│  ┌────────────────────┐                          │
│  │ 2단계: 보호자 1차    │                          │
│  │ • 1순위 보호자 알림   │                          │
│  │ • SMS + 푸시 알림     │                          │
│  │ • 환자 상태 공유      │                          │
│  └─────────┬──────────┘                          │
│            │ 15분 무응답                           │
│            ▼                                     │
│  ┌────────────────────┐                          │
│  │ 3단계: 보호자 2차    │                          │
│  │ + 긴급 연락처        │                          │
│  │ • 전체 보호자 알림    │                          │
│  │ • 긴급 연락처 SMS     │                          │
│  │ • AI 음성 통화 시도   │                          │
│  └─────────┬──────────┘                          │
│            │ 15분 무응답                           │
│            ▼                                     │
│  ┌────────────────────┐                          │
│  │ 4단계: 119 자동 신고  │                          │
│  │ • 환자 정보 전송      │                          │
│  │ • GPS 위치 전송       │                          │
│  │ • 건강 데이터 전송     │                          │
│  └────────────────────┘                          │
│                                                  │
│  ※ 어느 단계에서든 "괜찮아요" 확인 시 에스컬레이션 중지│
└──────────────────────────────────────────────────┘
```

### 119 자동 호출 화면
```
┌─────────────────────────────┐
│  🚑 119 긴급 신고 진행 중     │
├─────────────────────────────┤
│                             │
│  ⚠️ 보호자 응답 없음 (33분)   │
│  119 자동 신고를 진행합니다   │
│                             │
│  전송 정보:                  │
│  ┌─────────────────────────┐│
│  │ 환자: 홍OO (68세, 남성)  ││
│  │ 혈액형: A+              ││
│  │ 기저질환: 당뇨(Type 2)  ││
│  │ 복용약물: 메트포르민     ││
│  │                         ││
│  │ 위치:                   ││
│  │ 서울시 종로구 세종로 1    ││
│  │ GPS: 37.5760, 126.9769  ││
│  │ [지도 미리보기]          ││
│  │                         ││
│  │ 건강 데이터:             ││
│  │ 혈당: 285 mg/dL (위험)  ││
│  │ 24시간 추이: 급격 상승   ││
│  │ AI 위험도: 높음          ││
│  └─────────────────────────┘│
│                             │
│  📞 119 연결 중...           │
│  [========          ] 40%   │
│                             │
│  [신고 취소 (보호자 확인)]   │
│                             │
│  ⚠️ 취소 시 사유 기록이       │
│  필요합니다                  │
└─────────────────────────────┘
```

### 설명
- **4단계 에스컬레이션**: 이상 감지 → 본인 알림(3분) → 보호자 1차(15분) → 보호자 2차 + 긴급 연락처(15분) → 119 자동 신고로 단계적으로 대응한다.
- **119 자동 호출**: 환자 기본 정보, GPS 위치, 건강 데이터(혈당 수치, 24시간 추이, AI 위험도)를 119에 자동 전송한다.
- **신고 취소**: 보호자가 상황을 확인한 경우 신고를 취소할 수 있으며, 취소 사유를 기록한다.
- **감사 로그**: 모든 에스컬레이션 단계와 결과가 감사 로그에 기록된다.

### UX 포인트
- 각 단계 전환 시 남은 시간 카운트다운 표시
- AI 음성 통화 (3단계): 환자에게 자동 음성 통화로 상태 확인 시도
- 119 데이터 패킷: FHIR 형식 환자 요약 + GPS 좌표 + 측정 데이터
- 신고 취소 시: 취소 사유 선택 (본인 확인/보호자 확인/오감지) + 감사 로그 기록

### 접근성
- 에스컬레이션 상태: 시각(프로그레스) + 청각(경고음) + 촉각(진동)
- 119 호출 화면: 최대 밝기 + 화면 꺼짐 방지
- 신고 취소 버튼: 56x56dp, 명확한 라벨

### 음성 안내 (TTS)
> "119 긴급 신고가 진행 중입니다. 환자 정보와 위치가 전송됩니다. 보호자가 확인하셨다면 신고 취소 버튼을 누르세요."

---

## 장면 4: 관리자 포탈 연동

### 와이어프레임
```
┌─────────────────────────────┐
│  ◀  긴급 이벤트 대시보드      │
│         (관리자 포탈)        │
├─────────────────────────────┤
│                             │
│ 📊 실시간 긴급 이벤트 현황     │
│ ┌─────────────────────────┐ │
│ │ 🔴 활성 긴급: 3건         │ │
│ │ 🟡 모니터링 중: 12건      │ │
│ │ ✅ 오늘 해결: 8건         │ │
│ │ 📞 119 신고: 1건          │ │
│ └─────────────────────────┘ │
│                             │
│ 📍 지역별 긴급 이벤트 맵       │
│ ┌─────────────────────────┐ │
│ │       [대한민국 지도]      │ │
│ │                         │ │
│ │    서울 🔴(2)            │ │
│ │         경기 🟡(5)       │ │
│ │    대전 🟡(2)            │ │
│ │              부산 🔴(1)  │ │
│ │    광주 🟢(0)            │ │
│ └─────────────────────────┘ │
│                             │
│ 📋 최근 긴급 이벤트 로그       │
│ ┌─────────────────────────┐ │
│ │ 14:32 홍OO 혈당 285 🔴   │ │
│ │  └ 에스컬레이션 2단계 진행 │ │
│ │ 13:15 김OO 혈당 62  🟡   │ │
│ │  └ 본인 확인 완료 ✅      │ │
│ │ 11:40 박OO 혈당 310 🔴   │ │
│ │  └ 119 신고 완료          │ │
│ │ 09:22 이OO 변동폭 초과 🟡│ │
│ │  └ 보호자 확인 완료 ✅    │ │
│ └─────────────────────────┘ │
│                             │
│ 📊 월간 통계                  │
│ ┌─────────────────────────┐ │
│ │ 총 긴급 이벤트: 156건     │ │
│ │ 119 신고: 3건             │ │
│ │ 평균 대응 시간: 4분 32초   │ │
│ │ 오감지율: 2.3%            │ │
│ └─────────────────────────┘ │
│                             │
│ [📋 감사 로그] [📊 상세 통계]│
└─────────────────────────────┘
```

### 설명
- **긴급 이벤트 대시보드**: 관리자 포탈에서 실시간 긴급 이벤트 현황을 모니터링한다.
- **지역별 맵**: 지역별 긴급 이벤트를 지도 위에 색상 아이콘으로 시각화한다.
- **이벤트 로그**: 최근 긴급 이벤트 타임라인과 처리 상태를 실시간으로 표시한다.
- **월간 통계**: 총 이벤트 수, 119 신고 건수, 평균 대응 시간, 오감지율 등 핵심 지표를 집계한다.
- **감사 로그**: 모든 긴급 대응 행위에 대한 상세 감사 로그를 조회한다.

### UX 포인트
- 실시간 업데이트: WebSocket/SSE로 대시보드 자동 갱신
- 지도 클릭 시 해당 지역 이벤트 상세 목록 표시
- 이벤트 로그 클릭 시 해당 환자의 전체 에스컬레이션 타임라인 표시
- AdminService.GetEmergencyDashboard RPC 호출

### 접근성
- 대시보드 숫자: 스크린리더 "활성 긴급 3건, 모니터링 중 12건"
- 지도: 텍스트 대안 목록 제공 (지역별 이벤트 수)
- 로그: 시간순 정렬, 상태 아이콘 + 텍스트 병용

### 음성 안내 (TTS)
> "긴급 이벤트 대시보드입니다. 현재 활성 긴급 이벤트 3건, 모니터링 중 12건입니다."

---

## 네비게이션 흐름

```
┌──────────┐      ┌──────────────────┐
│ 설정     │─────▶│ 긴급 대응 설정    │
│ /settings│      │ /settings/       │
└──────────┘      │ emergency        │
                  └────────┬─────────┘
                           │
              ┌────────────┼────────────┐
              │            │            │
        ┌─────▼─────┐ ┌───▼────┐ ┌────▼───────┐
        │ 연락처    │ │ 감지   │ │ 119 설정   │
        │ CRUD     │ │ 기준   │ │ 토글       │
        └───────────┘ └────────┘ └────────────┘

┌──────────────┐      ┌──────────────┐
│ 이상 감지     │─────▶│ 알림 상세    │
│ (푸시 알림)   │      │              │
└──────────────┘      └──────┬───────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
        ┌─────▼─────┐ ┌─────▼─────┐ ┌─────▼─────┐
        │ 보호자    │ │ 긴급 진료 │ │ 119 신고  │
        │ 전화     │ │ 예약      │ │           │
        └───────────┘ └───────────┘ └───────────┘
```

- **Settings → Emergency**: 설정 메뉴에서 긴급 대응 설정 진입
- **Emergency → FamilyAlert**: 에스컬레이션 진행 시 가족/보호자 알림 자동 전송
- **Alert → 119Call**: 긴급 행동 버튼 또는 자동 에스컬레이션으로 119 신고
- **Alert → MedicalBooking**: 긴급 진료 예약 버튼으로 TelemedicineService 연동

---

## 기술 참조

- `frontend/flutter-app/lib/features/settings/` 긴급 대응 설정 화면
- `docs/ux/storyboard-family-management.md` 장면 4-5 긴급 알림 연계
- `backend/shared/proto/manpasik.proto` NotificationService, FamilyService, AdminService
- 에스컬레이션 엔진: 서버 사이드 스케줄러 (단계별 타이머 관리)
- 119 연동: 응급 의료 정보 전송 API (FHIR Patient + GPS)
- AI 음성 통화: TTS + STT 기반 자동 상태 확인 (3단계)

---

## 접근성 종합

- 긴급 알림: Do Not Disturb 우회, 최대 밝기, 화면 깨움
- 모든 긴급 버튼: 최소 56x56dp, 빨간색 배경 + 흰색 텍스트
- 슬라이더: 스크린리더 수치 읽기, 키보드 조작 지원
- 시니어 모드: 긴급 버튼 크기 1.5배, 음성 안내 자동 재생
- 색각 이상 대응: 상태 표시 색상 + 아이콘 + 텍스트 라벨 병용
- 진동 패턴: 위험도별 차등 (주의: 짧은 진동, 경고: 중간, 위험: 연속 긴 진동)
