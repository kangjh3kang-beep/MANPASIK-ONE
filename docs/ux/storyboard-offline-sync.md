# 오프라인 동기화 사용자 여정 스토리보드

**문서번호**: MPK-UX-SB-OFFLINE-v1.0
**기준**: 원본 기획안 V. 5.8절 오프라인 완전 구동 + IV. 오프라인-온라인 동기화
**Phase**: Phase 1
**최종 갱신**: 2026-02-15

> **참고**: 이 스토리보드는 전용 화면이 아닌 **글로벌 UI 오버레이**로서의 동작을 설명합니다.
> 모든 화면에 걸쳐 표시되는 네트워크 상태 인디케이터, 오프라인 측정 워크플로우,
> 자동 동기화 프로세스를 다룹니다.

---

## 장면 1: 오프라인 측정 모드

### 와이어프레임 — 오프라인 전환 시
```
┌─────────────────────────────┐
│ ⚠️ 오프라인 모드  📡✕        │
│ 네트워크 연결 없음 — 로컬 모드│
├═════════════════════════════┤
│  ◀  홈                       │
├─────────────────────────────┤
│ ┌─────────────────────────┐ │
│ │  ✨ 건강 상태 요약        │ │
│ │                         │ │
│ │  마지막 측정: 오늘 09:30 │ │
│ │  혈당 102 mg/dL  [정상]  │ │
│ │                         │ │
│ │ [ ⚡ 지금 측정 시작하기 ] │ │
│ │   (오프라인에서도 가능)    │ │
│ └─────────────────────────┘ │
│                             │
│  퀵 액션                     │
│  ┌──────┐ ┌──────┐         │
│  │ 📊   │ │ 🤖   │         │
│  │데이터 │ │AI코치 │         │
│  │(캐시) │ │(제한) │         │
│  └──────┘ └──────┘         │
│  ┌──────┐ ┌──────┐         │
│  │ 👨‍👩‍👧‍👦  │ │ 🏥   │         │
│  │ 가족  │ │ 의료  │         │
│  │(캐시) │ │(불가) │         │
│  └──────┘ └──────┘         │
│                             │
│ ┌─────────────────────────┐ │
│ │ 📤 동기화 대기 큐: 3건    │ │
│ │ • 09:30 혈당 측정 결과   │ │
│ │ • 09:15 설정 변경         │ │
│ │ • 08:50 프로필 수정       │ │
│ │ 네트워크 복구 시 자동 동기화│ │
│ └─────────────────────────┘ │
└─────────────────────────────┘
```

### 오프라인 측정 진행 화면
```
┌─────────────────────────────┐
│ ⚠️ 오프라인 모드  📡✕        │
├═════════════════════════════┤
│  ◀  측정 중                  │
├─────────────────────────────┤
│                             │
│   📱 ManPaSik-LE-A102       │
│   BLE 연결됨 (로컬)          │
│                             │
│  ┌─────────────────────────┐│
│  │                         ││
│  │   [  측정 파동 시각화  ] ││
│  │   ((  Measuring...  ))  ││
│  │                         ││
│  │   88채널 데이터 수집 중   ││
│  │   [=============   ] 75%││
│  │                         ││
│  └─────────────────────────┘│
│                             │
│  🧠 Rust AI 로컬 분석 대기    │
│  • TFLite 모델 (로컬)        │
│  • 오프라인 분류 엔진 준비    │
│                             │
│  ⚡ 오프라인에서도 AI 분석이   │
│  가능합니다.                  │
│                             │
└─────────────────────────────┘
```

### 오프라인 측정 결과 화면
```
┌─────────────────────────────┐
│ ⚠️ 오프라인 모드  📡✕        │
├═════════════════════════════┤
│  ◀  측정 결과                │
├─────────────────────────────┤
│                             │
│  혈당: 108 mg/dL   [정상]   │
│                             │
│  ┌─────────────────────────┐│
│  │ 🧠 AI 분석 (로컬)        ││
│  │                         ││
│  │ 분석 엔진: Rust TFLite   ││
│  │ 신뢰도: 94%              ││
│  │                         ││
│  │ "정상 범위입니다.         ││
│  │  식후 2시간 측정도         ││
│  │  권장합니다."              ││
│  │                         ││
│  │ ℹ️ 온라인 연결 시 클라우드 ││
│  │ AI로 더 정밀한 분석이     ││
│  │ 가능합니다.               ││
│  └─────────────────────────┘│
│                             │
│  ┌─────────────────────────┐│
│  │ 💾 로컬 저장 완료         ││
│  │ 📤 동기화 대기 큐 추가    ││
│  │    (4건 대기 중)          ││
│  └─────────────────────────┘│
│                             │
│  [홈으로]  [다시 측정]        │
└─────────────────────────────┘
```

### 설명
- **오프라인 배너**: 화면 최상단에 빨간색 배경의 글로벌 배너 표시. 네트워크 상태 아이콘(📡✕) + "오프라인 모드" 텍스트.
- **측정 정상 수행**: BLE는 로컬 통신이므로 오프라인에서도 리더기 연결 및 측정 완전 동작.
- **Rust AI 로컬 분석**: TFLite 모델을 통한 온-디바이스 AI 분석. 기본 분류, 이상치 감지, 핑거프린트 매칭 모두 로컬 수행 가능.
- **결과 저장 큐**: 측정 결과를 로컬 SQLite에 저장 + 동기화 대기 큐에 추가. "N건 동기화 대기 중" 표시.
- **기능 제한 표시**: 온라인 필수 기능(화상진료, 마켓 결제 등)은 "(불가)" 라벨, 캐시 가능 기능은 "(캐시)" 라벨.

### UX 포인트
- 오프라인 전환 시 토스트 알림: "네트워크 연결이 끊어졌습니다. 오프라인 모드로 전환합니다."
- 측정 버튼은 오프라인에서도 항상 활성화 상태 (핵심 기능 보장).
- 로컬 AI 분석 신뢰도 표시 (클라우드 AI보다 낮을 수 있음을 안내).
- 동기화 큐 탭 시 대기 항목 상세 리스트 확인 가능.

### 접근성
- 오프라인 배너: 스크린리더 "오프라인 모드, 네트워크 연결 없음, 로컬 모드로 동작 중".
- 동기화 대기 큐: "동기화 대기 중 4건, 네트워크 복구 시 자동 동기화됩니다".
- 기능 제한 라벨: "(불가)" 항목 탭 시 "이 기능은 네트워크 연결이 필요합니다" 음성 안내.

### 음성 안내 (TTS)
> "오프라인 모드입니다. 측정과 AI 분석은 정상적으로 이용하실 수 있습니다. 현재 4건의 데이터가 동기화 대기 중입니다."

---

## 장면 2: 자동 동기화

### 와이어프레임 — 네트워크 복구 감지
```
┌─────────────────────────────┐
│ 🔄 동기화 중  📡 ↑↓          │
│ 4건 데이터 업로드 중...       │
├═════════════════════════════┤
│  (현재 사용 중인 화면 내용)   │
│                             │
│                             │
│                             │
│                             │
│                             │
│                             │
│                             │
│                             │
│                             │
│                             │
│                             │
│                             │
│                             │
│                             │
│                             │
│                             │
│                             │
└─────────────────────────────┘
```

### 동기화 진행 상세 (알림 센터 또는 탭으로 확인)
```
┌─────────────────────────────┐
│  ◀  동기화 상태              │
├─────────────────────────────┤
│                             │
│  🔄 동기화 진행 중            │
│  [===============     ] 75% │
│                             │
│  전체: 4건 / 완료: 3건       │
│                             │
│ ┌─────────────────────────┐ │
│ │ ✅ 09:30 혈당 측정 결과   │ │
│ │    업로드 완료            │ │
│ ├─────────────────────────┤ │
│ │ ✅ 09:15 설정 변경         │ │
│ │    업로드 완료            │ │
│ ├─────────────────────────┤ │
│ │ ✅ 08:50 프로필 수정       │ │
│ │    업로드 완료            │ │
│ ├─────────────────────────┤ │
│ │ 🔄 08:30 혈당 측정 결과   │ │
│ │    업로드 중... (67%)     │ │
│ └─────────────────────────┘ │
│                             │
│ ⚡ Wi-Fi 연결 감지 —          │
│ 고속 동기화 모드 활성화       │
└─────────────────────────────┘
```

### 동기화 완료 토스트
```
┌─────────────────────────────┐
│                             │
│  (현재 사용 중인 화면 내용)   │
│                             │
│                             │
│                             │
│                             │
│                             │
│                             │
│                             │
│                             │
│                             │
│                             │
│                             │
│  ┌─────────────────────────┐│
│  │ ✅ 4건 동기화 완료        ││
│  │ 클라우드 AI 분석 업데이트 ││
│  │ 가능                     ││
│  └─────────────────────────┘│
└─────────────────────────────┘
```

### 충돌 해결 화면
```
┌─────────────────────────────┐
│  ◀  동기화 충돌 해결         │
├─────────────────────────────┤
│                             │
│  ⚠️ 1건의 데이터 충돌이       │
│  감지되었습니다.              │
│                             │
│ ┌─────────────────────────┐ │
│ │ 설정: 알림 설정 변경       │ │
│ │                         │ │
│ │ 📱 로컬 (오프라인 변경)    │ │
│ │ 시각: 09:15              │ │
│ │ 측정 알림: OFF            │ │
│ │                         │ │
│ │ ☁️ 서버 (다른 기기에서)    │ │
│ │ 시각: 09:20              │ │
│ │ 측정 알림: ON             │ │
│ │                         │ │
│ │ 권장: 서버 버전 (최신)     │ │
│ │                         │ │
│ │ [로컬 유지] [서버 적용]   │ │
│ └─────────────────────────┘ │
│                             │
│ 💡 기본 정책: LWW (최신 쓰기 │
│ 우선). 측정 데이터는 자동     │
│ 병합됩니다.                  │
└─────────────────────────────┘
```

### 설명
- **네트워크 복구 감지**: 연결 상태 변경 시 자동으로 동기화 프로세스 시작. 사용자 개입 불필요.
- **동기화 프로그레스**: 글로벌 배너에 진행 상태 표시 (주황색 배경, 🔄 아이콘 회전 애니메이션).
- **완료 토스트**: 하단 스낵바로 "N건 동기화 완료" 표시, 3초 후 자동 사라짐.
- **충돌 해결**: LWW(Last Writer Wins) 기반 자동 해결이 기본. 측정 데이터는 항상 양쪽 모두 보존 (병합). 설정/프로필 등 단일 값은 최신 타임스탬프 우선, 수동 선택 옵션도 제공.
- **Delta Sync**: 변경분만 전송하여 대역폭 최소화.

### UX 포인트
- 동기화는 백그라운드 자동 실행, 사용자 UX 차단하지 않음.
- Wi-Fi 감지 시 고속 동기화 모드 (벌크 업로드).
- 셀룰러 데이터 시 사용자 설정에 따라 동기화 보류 가능.
- 동기화 실패 시 자동 재시도 (지수 백오프: 1초→2초→4초→8초→최대 60초).
- 측정 데이터 충돌: 양쪽 모두 보존 (의료 데이터 유실 방지 원칙).

### 접근성
- 동기화 배너: 스크린리더 "동기화 중, 4건 중 3건 완료".
- 완료 토스트: "4건 동기화 완료" 음성 안내.
- 충돌 해결: 각 옵션 상세 설명 스크린리더 지원.

### 음성 안내 (TTS)
> "네트워크가 복구되었습니다. 4건의 데이터를 동기화하고 있습니다."
> (완료 시) "동기화가 완료되었습니다. 4건의 데이터가 클라우드에 저장되었습니다."

---

## 장면 3: 네트워크 상태 인디케이터

### 와이어프레임 — 글로벌 헤더 위젯 상태별
```
연결됨 (정상):
┌─────────────────────────────┐
│ ✅ 연결됨  📡               │ (초록색 배경 — 2초 후 자동 숨김)
├═════════════════════════════┤
│  (화면 내용)                 │
└─────────────────────────────┘

오프라인:
┌─────────────────────────────┐
│ ⚠️ 오프라인 모드  📡✕        │ (빨간색 배경 — 상시 표시)
├═════════════════════════════┤
│  (화면 내용)                 │
└─────────────────────────────┘

동기화 중:
┌─────────────────────────────┐
│ 🔄 동기화 중 (3/4)  📡 ↑↓   │ (주황색 배경 — 완료까지 표시)
├═════════════════════════════┤
│  (화면 내용)                 │
└─────────────────────────────┘

동기화 완료:
┌─────────────────────────────┐
│ ✅ 4건 동기화 완료  📡       │ (초록색 배경 — 3초 후 자동 숨김)
├═════════════════════════════┤
│  (화면 내용)                 │
└─────────────────────────────┘

동기화 오류:
┌─────────────────────────────┐
│ ❌ 동기화 실패 (재시도 중)    │ (빨간색 배경 — 탭하여 상세)
├═════════════════════════════┤
│  (화면 내용)                 │
└─────────────────────────────┘
```

### 상태 전이 다이어그램
```
         네트워크 연결
    ┌───────────────────────┐
    ▼                       │
┌────────┐  연결 끊김   ┌────────┐
│연결됨   │ ──────────→ │오프라인 │
│(초록)   │             │(빨강)  │
└────┬───┘             └────┬───┘
     │                      │
     │ 동기화 큐 있음         │ 네트워크 복구 +
     │ (자동 시작)           │ 동기화 큐 있음
     │                      │
     ▼                      ▼
┌─────────┐           ┌─────────┐
│동기화 중  │◄──────────│동기화 중  │
│(주황)    │           │(주황)    │
└────┬────┘           └─────────┘
     │
     ├── 성공 ──→ 동기화 완료 (초록, 3초) ──→ 연결됨 (숨김)
     │
     └── 실패 ──→ 동기화 오류 (빨강) ──→ 자동 재시도
```

### 색상 코드표
```
┌──────────────────────────────────────────────┐
│ 상태         │ 색상    │ 코드      │ 지속시간 │
├──────────────┼─────────┼───────────┼─────────┤
│ 연결됨       │ 🟢 초록 │ #4CAF50   │ 2초 숨김 │
│ 오프라인     │ 🔴 빨강 │ #F44336   │ 상시    │
│ 동기화 중    │ 🟠 주황 │ #FF9800   │ 완료까지│
│ 동기화 완료  │ 🟢 초록 │ #4CAF50   │ 3초 숨김│
│ 동기화 오류  │ 🔴 빨강 │ #F44336   │ 해결까지│
└──────────────────────────────────────────────┘
```

### 설명
- **글로벌 배너**: 모든 화면 최상단에 SafeArea 아래 위치. 현재 네트워크/동기화 상태를 색상 코드로 표시.
- **자동 숨김**: 정상 상태(연결됨, 동기화 완료)는 일정 시간 후 자동 숨김하여 화면 공간 확보.
- **상시 표시**: 비정상 상태(오프라인, 동기화 오류)는 해결될 때까지 계속 표시.
- **동기화 중**: 진행 건수 표시 (3/4), 회전 애니메이션.
- **탭 인터랙션**: 배너 탭 시 동기화 상세 화면으로 이동.

### UX 포인트
- 배너 높이: 32dp (콤팩트). 화면 콘텐츠 영역 최소 침범.
- 애니메이션: 상태 전환 시 슬라이드 다운/업 트랜지션 (300ms).
- 오프라인 → 연결됨 전환 시 햅틱 피드백 (가벼운 진동).
- 동기화 오류 배너 탭 시 오류 상세 + 수동 재시도 버튼.
- 앱 설정에서 배너 표시 여부 커스터마이즈 가능 (고급 사용자).

### 접근성
- 상태 변경: 스크린리더 라이브 리전(live region)으로 자동 알림.
- 오프라인 전환: "네트워크 연결이 끊어졌습니다. 오프라인 모드로 전환합니다."
- 동기화 완료: "4건 동기화가 완료되었습니다."
- 색상 + 아이콘 + 텍스트 3중 인코딩 (색각 이상 대응).

### 음성 안내 (TTS)
> (오프라인 전환) "네트워크 연결이 끊어졌습니다. 오프라인 모드입니다. 측정과 기본 기능은 정상 이용 가능합니다."
> (연결 복구) "네트워크가 복구되었습니다. 대기 중인 데이터를 동기화합니다."
> (동기화 완료) "동기화가 완료되었습니다."

---

## 내비게이션 플로우

```
글로벌 오버레이 (모든 화면 적용)
═══════════════════════════════

  [네트워크 끊김 감지]
         │
         ▼
  ┌──────────────────┐
  │ 오프라인 배너 표시 │
  │ (글로벌 상단)      │
  └────────┬─────────┘
           │
    ┌──────┴──────┐
    ▼             ▼
┌────────┐  ┌──────────┐
│측정 수행│  │기타 기능  │
│(정상)  │  │(제한 표시)│
└───┬────┘  └──────────┘
    │
    ▼
┌──────────────┐
│로컬 AI 분석   │
│결과 표시      │
└───┬──────────┘
    │
    ▼
┌──────────────┐
│로컬 저장 +    │
│동기화 큐 추가  │
└───┬──────────┘
    │
    │  [네트워크 복구 감지]
    │         │
    ▼         ▼
┌──────────────────┐
│자동 동기화 시작    │
│(배너: 동기화 중)   │
└───┬──────────────┘
    │
    ├── 성공 ──→ 완료 토스트 ──→ 배너 숨김
    │
    └── 충돌 ──→ LWW 자동 해결 (측정: 병합, 설정: 최신 우선)
                 │
                 └── 수동 필요 시 ──→ 충돌 해결 화면
```

---

## 기술 노트

- **네트워크 감지**: `connectivity_plus` 패키지로 연결 상태 모니터링 (Wi-Fi/셀룰러/없음)
- **로컬 저장소**: SQLite WAL 모드 (측정 데이터), Sled KV (AI 모델 캐시), SharedPreferences (설정)
- **동기화 큐**: CRDT 기반 Delta Sync. 변경분만 큐에 적재, 네트워크 복구 시 순차 업로드
- **충돌 해결**: LWW(Last Writer Wins) + 벡터 클록. 측정 데이터는 항상 양쪽 보존 (의료 데이터 무손실 원칙)
- **Rust 엔진**: `rust-core/manpasik-engine/src/ai/mod.rs` — TFLite 로컬 추론, `src/ble/mod.rs` — BLE 로컬 통신
- **오프라인 AI**: TFLite 기본 분류 모델 (~5MB), 핑거프린트 CNN (~3MB), 이상치 감지 (로컬 통계 기반)
- **동기화 프로토콜**: gRPC `SyncService.PushChanges`, `SyncService.PullChanges` (Phase 1 기본 구현)
- **용량 계획**: 표준 사용(3회/일) 기준 월 ~450KB, 1년 ~5.4MB. 로컬 저장소 최대 500MB (SQLite)
- **참조 문서**: `docs/specs/offline-capability-matrix.md` — 기능별 온/오프라인 지원 상세 매트릭스

## 참조
- `docs/ux/sitemap.md` 글로벌 UI 공통 요소 (네트워크 인디케이터)
- `docs/plan/MPK-ECO-PLAN-v1.1-COMPLETE.md` V. 5.8절 오프라인 완전 구동, IV. 오프라인-온라인 동기화
- `docs/specs/offline-capability-matrix.md`
- `backend/shared/proto/manpasik.proto` SyncService (Delta Sync)
- `rust-core/manpasik-engine/src/ai/mod.rs`
- `rust-core/manpasik-engine/src/ble/mod.rs`
