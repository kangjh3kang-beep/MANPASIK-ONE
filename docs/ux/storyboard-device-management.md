# 기기 관리 사용자 여정 스토리보드

**문서번호**: MPK-UX-SB-DEVICE-v1.0
**기준**: 사이트맵 v1.1 (/devices) + 원본 기획안 V. 5.2절 다수 리더기 관리
**Phase**: Phase 1
**최종 갱신**: 2026-02-15

---

## 장면 1: 기기 목록

### 와이어프레임
```
┌─────────────────────────────┐
│  ◀  기기 관리                │
├─────────────────────────────┤
│  내 리더기 (1/1대)           │
│  구독: Free (최대 1대)       │
│  [Basic으로 업그레이드 →]    │
├─────────────────────────────┤
│ ┌─────────────────────────┐ │
│ │ 📱 ManPaSik-LE-A102      │ │
│ │                         │ │
│ │ 상태: 🟢 연결됨           │ │
│ │ 배터리: ████████░░ 82%   │ │
│ │ 펌웨어: v1.2.3           │ │
│ │ 용도: 개인               │ │
│ │                         │ │
│ │ 마지막 사용: 오늘 09:30   │ │
│ │                         │ │
│ │ [상세보기]               │ │
│ └─────────────────────────┘ │
│                             │
│ ┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐ │
│   + 리더기 추가하기          │
│     (BLE 스캔 시작)         │
│ └ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘ │
│                             │
├─────────────────────────────┤
│ 💡 구독별 리더기 등록 한도    │
│  Free: 1대 │ Basic: 2대    │
│  Pro: 5대  │ Clinical: 10대│
├─────────────────────────────┤
│  🏠   📊   ⬡   🛒   ⚙️   │
└─────────────────────────────┘
```

### 설명
- **등록 리더기 카드**: 기기명, 연결 상태(LED 아이콘), 배터리 잔량, 펌웨어 버전, 용도 분류, 마지막 사용 시간 표시.
- **연결 상태 LED**: 🟢 연결됨 / 🟡 대기 / 🔴 연결 끊김 / ⚪ 미등록.
- **구독 등급별 대수 제한**: Free 1대, Basic 2대, Pro 5대, Clinical 10대. 현재 등록/최대 대수 표시.
- **기기 추가 버튼**: 등록 한도 미달 시 활성화, 한도 초과 시 비활성 + 구독 업그레이드 안내.
- **gRPC**: `DeviceService.ListDevices` 호출.

### UX 포인트
- 기기 카드는 연결 상태에 따라 테두리 색상 변경 (연결됨: 녹색, 끊김: 빨간색 점선).
- 구독 한도 도달 시 추가 버튼 대신 업그레이드 CTA 표시.
- 기기 없을 시: "리더기를 등록하여 측정을 시작하세요!" + 온보딩 페어링 가이드 링크.

### 접근성
- 연결 상태: 색상 + 텍스트 라벨 병용 ("연결됨", "연결 끊김").
- 배터리: 스크린리더 "배터리 82퍼센트".
- 기기 카드: 최소 터치 영역 48x48dp.

### 음성 안내 (TTS)
> "기기 관리 화면입니다. 현재 1대의 리더기가 등록되어 있습니다. ManPaSik LE A102, 연결 상태 양호, 배터리 82퍼센트입니다."

---

## 장면 2: BLE 기기 검색 다이얼로그

### 와이어프레임
```
┌─────────────────────────────┐
│       BLE 디바이스 검색       │
├─────────────────────────────┤
│                             │
│     (( 📡 스캔 중... ))      │
│                             │
│   주변 기기를 검색하고 있습니다 │
│   리더기 전원이 켜져 있는지    │
│   확인해주세요.               │
│                             │
│   [==============    ] 70%  │
│                             │
├─────────────────────────────┤
│ 검색된 기기 (2)              │
│ ┌─────────────────────────┐ │
│ │ 📱 ManPaSik-LE-B205      │ │
│ │    RSSI: -42 dBm (강함)  │ │
│ │    [ 연결하기 ]           │ │
│ ├─────────────────────────┤ │
│ │ 📱 ManPaSik-LE-C301      │ │
│ │    RSSI: -68 dBm (보통)  │ │
│ │    [ 연결하기 ]           │ │
│ └─────────────────────────┘ │
│                             │
├─────────────────────────────┤
│  [닫기]       [다시 검색]    │
└─────────────────────────────┘
```

### 검색 실패 상태
```
┌─────────────────────────────┐
│       BLE 디바이스 검색       │
├─────────────────────────────┤
│                             │
│     ❌ 기기를 찾을 수 없음    │
│                             │
│   다음을 확인해주세요:         │
│   1. 리더기 전원이 켜져 있나요?│
│   2. 파란 불빛이 깜빡이나요?  │
│   3. 블루투스가 활성화되어     │
│      있나요?                 │
│   4. 위치 권한이 허용되어     │
│      있나요?                 │
│                             │
│  [권한 설정 열기] [다시 검색]  │
│  [도움말 보기]                │
├─────────────────────────────┤
│  [닫기]                      │
└─────────────────────────────┘
```

### 설명
- **BLE 스캔**: 다이얼로그 진입 시 Rust FFI (`RustBridge.bleScan()`)를 통한 BLE 디바이스 자동 검색 시작.
- **검색 결과**: 발견된 기기 이름, RSSI 신호 강도(강함/보통/약함), 연결 버튼 표시.
- **연결**: 탭 시 `DeviceService.RegisterDevice` gRPC 호출 → BLE 페어링 → 기기 LED 녹색 점등.
- **다시 검색**: 스캔 재시작.
- **권한 요청**: BLE/위치 권한 미허용 시 시스템 설정 팝업 유도.

### UX 포인트
- 스캔 중 애니메이션 (파동 효과) 표시.
- RSSI에 따른 신호 강도 아이콘 (강함 3칸, 보통 2칸, 약함 1칸).
- 검색 실패 시 단계별 트러블슈팅 가이드 제공.
- 연결 성공 시 햅틱 피드백 + 성공 토스트.

### 접근성
- 스캔 상태: 스크린리더 "기기 검색 중, 2대 발견됨".
- 연결 버튼: 접근성 라벨 "ManPaSik LE B205 연결하기".
- 로딩 인디케이터: "검색 진행률 70퍼센트".

### 음성 안내 (TTS)
> "주변 기기를 검색하고 있습니다. 리더기 전원이 켜져 있는지 확인해주세요."

---

## 장면 3: 기기 상세 & 관리

### 와이어프레임
```
┌─────────────────────────────┐
│  ◀  ManPaSik-LE-A102        │
├─────────────────────────────┤
│                             │
│  [  리더기 이미지 (3D)  ]    │
│                             │
│  상태: 🟢 연결됨             │
├─────────────────────────────┤
│  기기 정보                   │
│  ┌─────────────────────────┐│
│  │ 시리얼: MPK-2026-A102   ││
│  │ 모델: ManPaSik Reader v2││
│  │ 펌웨어: v1.2.3          ││
│  │ 하드웨어: rev.B          ││
│  │ BLE: 5.0 LE             ││
│  │ MAC: AA:BB:CC:DD:EE:FF  ││
│  └─────────────────────────┘│
├─────────────────────────────┤
│  배터리 상태                 │
│  ████████░░ 82%              │
│  예상 잔여: 약 14일          │
│  마지막 충전: 2026-02-12     │
├─────────────────────────────┤
│  용도별 분류                 │
│  ┌─────────────────────────┐│
│  │ ● 개인  ○ 가정  ○ 사무실 ││
│  └─────────────────────────┘│
│  📍 위치별 대시보드 (Phase 2) │
│     [오픈 예정]              │
├─────────────────────────────┤
│  펌웨어 업데이트              │
│  ┌─────────────────────────┐│
│  │ ⬆️ 새 펌웨어 v1.3.0      ││
│  │   개선사항:               ││
│  │   - BLE 연결 안정성 향상  ││
│  │   - 측정 정확도 개선       ││
│  │   [ 업데이트 시작 ]       ││
│  └─────────────────────────┘│
├─────────────────────────────┤
│  [연결 해제]   [기기 삭제]    │
└─────────────────────────────┘
```

### 펌웨어 업데이트 진행 화면
```
┌─────────────────────────────┐
│  펌웨어 업데이트 중            │
├─────────────────────────────┤
│                             │
│     ⬆️ v1.2.3 → v1.3.0      │
│                             │
│   [================    ] 80%│
│                             │
│   ⚠️ 업데이트 중 리더기       │
│   전원을 끄지 마세요.         │
│   약 2분 소요 예정            │
│                             │
│   단계: 펌웨어 설치 중 (3/4)  │
│   1. ✅ 다운로드 완료         │
│   2. ✅ 검증 완료             │
│   3. 🔄 설치 중...           │
│   4. ⬜ 재부팅 대기           │
│                             │
│   [취소] (설치 중 비활성화)    │
└─────────────────────────────┘
```

### 설명
- **기기 정보**: 시리얼 번호, 모델명, 펌웨어 버전, 하드웨어 리비전, BLE 버전, MAC 주소.
- **배터리**: 잔량 퍼센트 + 프로그레스 바 + 예상 잔여 사용일.
- **용도별 분류**: 개인/가정/사무실 라디오 선택 → `DeviceService.UpdateDevice` RPC.
- **위치별 대시보드**: Phase 2 예정, 현재 "오픈 예정" 플레이스홀더.
- **펌웨어 업데이트**: OTA 알림, 다운로드/검증/설치/재부팅 4단계 프로그레스.
- **연결 해제**: BLE 연결만 해제, 등록 유지.
- **기기 삭제**: 등록 완전 삭제 (2단계 확인 다이얼로그).

### UX 포인트
- 펌웨어 업데이트 중 화면 이탈 방지 (뒤로가기 비활성화, WillPopScope).
- 업데이트 실패 시 자동 롤백 + "업데이트에 실패했습니다. 기기를 재시작 후 다시 시도해주세요." 안내.
- 기기 삭제 시 이중 확인: "정말 이 기기를 삭제하시겠습니까? 삭제 후 재등록이 필요합니다."
- 연결 끊김 상태에서는 재연결 버튼 표시.

### 접근성
- 배터리: 스크린리더 "배터리 82퍼센트, 약 14일 사용 가능".
- 펌웨어 업데이트 진행률: "펌웨어 업데이트 80퍼센트, 설치 중".
- 삭제 버튼: 빨간색 + "기기 삭제" 텍스트, 최소 48x48dp.

### 음성 안내 (TTS)
> "기기 상세 정보입니다. ManPaSik LE A102, 펌웨어 버전 1.2.3, 배터리 82퍼센트입니다. 새 펌웨어 업데이트가 있습니다."

---

## 내비게이션 플로우

```
┌──────────┐
│ Devices  │
│ /devices │
└────┬─────┘
     │
     ├──── [+ 리더기 추가] ──→ ┌──────────────┐
     │                         │ BLE 스캔      │
     │                         │ 다이얼로그     │
     │                         └──────┬───────┘
     │                                │
     │                         [연결하기] 탭
     │                                │
     │                                ▼
     │                         ┌──────────────┐
     │                         │ 기기 등록 완료 │
     │                         │ (목록 갱신)    │
     │                         └──────────────┘
     │
     ├──── [기기 카드 탭] ──→ ┌──────────────┐
     │                        │ 기기 상세      │
     │                        │ Device Detail │
     │                        └──────┬───────┘
     │                               │
     │                        ┌──────┴───────┐
     │                        │              │
     │                        ▼              ▼
     │                 ┌────────────┐ ┌────────────┐
     │                 │ 펌웨어      │ │ 연결 해제 / │
     │                 │ 업데이트    │ │ 기기 삭제   │
     │                 └────────────┘ └────────────┘
     │
     └──── [업그레이드 →] ──→ /settings (구독 관리)
```

---

## 기술 노트

- **구현 파일**: `frontend/flutter-app/lib/features/devices/presentation/ble_scan_dialog.dart`
- **Rust FFI**: `RustBridge.bleScan()` — btleplug 기반 BLE 스캔, `DeviceInfoDto` (name, deviceId, rssi) 반환
- **gRPC 호출**: `DeviceService.ListDevices`, `DeviceService.RegisterDevice`, `DeviceService.UpdateDevice`, `DeviceService.RemoveDevice`
- **구독 한도**: 서버측 구독 등급 검증 → 한도 초과 시 `PERMISSION_DENIED` 에러 반환
- **OTA**: 펌웨어 바이너리 다운로드 → SHA-256 검증 → BLE DFU 프로토콜 전송 → 보안 부팅 검증
- **오프라인**: 기기 목록/상세는 로컬 캐시에서 조회 가능, BLE 스캔/페어링은 로컬 동작, 기기 등록/삭제는 온라인 필요 (오프라인 시 큐잉)

## 참조
- `docs/ux/sitemap.md` /devices 라우트
- `docs/plan/MPK-ECO-PLAN-v1.1-COMPLETE.md` V. 5.2절 다수 리더기
- `backend/shared/proto/manpasik.proto` DeviceService
- `frontend/flutter-app/lib/features/devices/presentation/ble_scan_dialog.dart`
- `rust-core/manpasik-engine/src/ble/mod.rs`
