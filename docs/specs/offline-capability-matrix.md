# 오프라인 기능 매트릭스

**문서번호**: MPK-SPEC-OFFLINE-v2.0
**기준**: 원본 기획안 5.8 오프라인 완전 구동 시스템
**목적**: 기능별 온라인/오프라인 지원 여부, 구현 방식, 용량 계획, 동기화 전략의 공식 기준

---

## 1. 기능 매트릭스 (상세)

### 1.1 핵심 측정 기능

| 기능 | 온라인 | 오프라인 | 구현 방식 | 데이터 크기 | 우선순위 |
|------|--------|----------|-----------|-----------|---------|
| 리더기 연결 (BLE 5.0) | O | O | 로컬 BLE 스택 (btleplug) | - | P0 |
| 카트리지 인식 (NFC) | O | O | 로컬 NFC 검증 (DESFire EV3) | 80~512B/태그 | P0 |
| 차동 측정 실행 | O | O | Rust 엔진 로컬 처리 (differential) | 1~14KB/측정 | P0 |
| 차동 보정 (α, 온도, 습도) | O | O | 로컬 보정 계수 적용 | NFC에서 로드 | P0 |
| 88채널 기본 측정 | O | O | Rust DSP + differential | ~352B raw | P0 |
| 448차원 확장 측정 | O | O | Rust DSP + FFT 확장 | ~1.8KB raw | P1 |
| 896차원 고급 측정 | O | O | Rust DSP + FFT 확장 | ~3.6KB raw | P1 |
| 1792차원 궁극 측정 | O | O | Rust E12-IF 시간축 확장 | ~7.2KB raw | P2 |

### 1.2 AI/분석 기능

| 기능 | 온라인 | 오프라인 | 구현 방식 | 모델 크기 | 우선순위 |
|------|--------|----------|-----------|----------|---------|
| AI 분석 (기본 분류) | O | O | TFLite 로컬 모델 (ai 모듈) | ~5MB | P0 |
| AI 분석 (고급 LLM) | O | 제한적 | 클라우드 LLM (온라인) / 경량 온-디바이스 (오프라인) | ~50MB (경량) | P2 |
| 핑거프린트 분류 | O | O | 로컬 CNN/Transformer 모델 | ~3MB | P0 |
| 건강 리포트 생성 | O | O | 로컬 템플릿 엔진 + 규칙 기반 | ~500KB 템플릿 | P1 |
| 건강 코칭 (AI) | O | 제한적 | 클라우드 LLM (상세) / 로컬 규칙 (기본) | ~2MB 규칙 | P2 |
| 음식 사진 분석 | O | O | 로컬 YOLO/MobileNet 모델 | ~15MB | P2 |
| 이상치 감지 | O | O | 로컬 통계 기반 (Z-score, IQR) | - | P0 |
| 추세 분석 | O | O | 로컬 시계열 분석 (이동 평균) | - | P1 |

### 1.3 데이터 관리

| 기능 | 온라인 | 오프라인 | 구현 방식 | 용량 | 우선순위 |
|------|--------|----------|-----------|------|---------|
| 건강 기록 조회 | O | O | SQLite 로컬 DB | 무제한 | P0 |
| 건강 기록 저장 | O | O | SQLite WAL 모드 | ~1KB/레코드 | P0 |
| 데이터 시각화 | O | O | FL Chart 로컬 렌더 | - | P0 |
| 참조 범위 표시 | O | O | 로컬 JSON 테이블 | ~50KB | P0 |
| 측정 이력 검색 | O | O | SQLite FTS5 전문 검색 | - | P1 |
| PDF 리포트 내보내기 | O | O | 로컬 PDF 생성 엔진 | - | P1 |
| 가족 건강 데이터 조회 | O | O | SQLite 다중 프로필 | - | P1 |

### 1.4 사용자 경험

| 기능 | 온라인 | 오프라인 | 구현 방식 | 우선순위 |
|------|--------|----------|-----------|---------|
| 알림 (로컬) | O | O | 로컬 알림 스케줄러 (flutter_local_notifications) | P0 |
| 사용자 설정 변경 | O | O | SharedPreferences + SQLite | P0 |
| 다국어 지원 | O | O | 로컬 번역 파일 (ARB) | P0 |
| 접근성 (TalkBack/VoiceOver) | O | O | Flutter Semantics | P0 |
| 다크 모드 | O | O | 로컬 테마 전환 | P1 |
| 위젯 (홈 화면) | O | O | 로컬 WidgetKit/Glance | P2 |

### 1.5 네트워크 의존 기능

| 기능 | 온라인 | 오프라인 | 구현 방식 | 우선순위 |
|------|--------|----------|-----------|---------|
| 화상진료 | O | X | WebRTC (온라인 필수) | P1 |
| 커뮤니티 | O | 캐시 | 최근 30개 게시물 캐시 (SQLite) | P2 |
| 쇼핑/결제 | O | 장바구니 | 장바구니 로컬, 결제는 온라인 | P2 |
| 데이터 동기화 | O | 대기열 | CRDT 큐 적재 (sync 모듈) | P0 |
| Push 알림 수신 | O | X | FCM/APNs (온라인 필수) | P1 |
| 펌웨어 업데이트 | O | X | OTA (온라인 필수) | P2 |
| AI 모델 업데이트 | O | X | 백그라운드 다운로드 | P2 |
| 카트리지 레지스트리 동기화 | O | 캐시 | 마지막 동기화 버전 캐시 | P1 |
| 의료진 원격 상담 예약 | O | 예약 캐시 | 기존 예약 조회만 오프라인 | P2 |
| 처방전 조회 | O | 캐시 | 최근 처방 캐시 | P2 |

---

## 2. 오프라인 데이터 저장 구조

### 2.1 저장소 계층

| 저장소 | 용도 | 기술 | 최대 용량 | 정리 정책 |
|--------|------|------|----------|----------|
| SQLite (WAL) | 구조화 데이터: 측정 결과, 프로필, 설정, 이력 | sqlite3 + drift (Flutter) | 500MB | 1년 이상 데이터 아카이브 |
| Sled (KV) | AI 모델 캐시, 핑거프린트 벡터, 세션 데이터 | sled 0.34+ | 200MB | LRU 캐시 (모델 2세대 유지) |
| 파일 시스템 | AI 모델 파일, 카트리지 보정, 미디어 캐시 | 플랫폼 앱 디렉토리 | 300MB | 미사용 30일 후 삭제 |
| SharedPreferences | 사용자 설정, 테마, 언어 | Platform KV | 1MB | 영구 보존 |
| Secure Storage | 인증 토큰, 암호화 키 | Keychain/Keystore | 10KB | 로그아웃 시 삭제 |

### 2.2 용량 계획 (디바이스별)

| 시나리오 | 일일 데이터 | 월간 데이터 | 1년 누적 |
|----------|-----------|-----------|---------|
| 경량 사용 (1회/일, 88채널) | ~5KB | ~150KB | ~1.8MB |
| 표준 사용 (3회/일, 88채널) | ~15KB | ~450KB | ~5.4MB |
| 고급 사용 (5회/일, 896채널) | ~50KB | ~1.5MB | ~18MB |
| 연구 사용 (10회/일, 1792차원) | ~150KB | ~4.5MB | ~54MB |

### 2.3 스토리지 관리

```
스토리지 사용량 모니터링:
├── 80% 사용 시: "저장 공간 부족" 경고
├── 90% 사용 시: "오래된 캐시 정리" 자동 실행
├── 95% 사용 시: "동기화 후 로컬 정리" 강력 권장
└── 99% 사용 시: "측정은 가능하나 저장 불가" 경고
```

---

## 3. CRDT 동기화 전략

### 3.1 CRDT 타입 매핑

| 데이터 | CRDT 타입 | 설명 |
|--------|----------|------|
| 측정 횟수 카운터 | GCounter | 단조 증가 카운터, 노드별 독립 증가 |
| 사용자 설정 | LWWRegister | Last-Write-Wins, 타임스탬프 기반 |
| 건강 기록 컬렉션 | ORSet (Observed-Remove Set) | 추가/삭제 동시 가능 |
| 동기화 버전 | VectorClock | 노드별 논리적 시간 추적 |
| 가족 공유 데이터 | LWWMap | 키별 LWW 레지스터 맵 |

### 3.2 동기화 프로토콜

```
오프라인 → 온라인 복구 시:
1. VectorClock 비교 (로컬 vs 서버)
2. 델타 계산 (변경된 항목만)
3. 우선순위 기반 전송:
   ├── P0: 측정 결과 (즉시)
   ├── P1: 건강 기록 변경 (5초 내)
   ├── P2: 설정 변경 (30초 내)
   └── P3: 캐시 갱신 (백그라운드)
4. 서버 확인 (ACK)
5. 로컬 VectorClock 업데이트
```

### 3.3 충돌 해소 전략

| 충돌 유형 | 해소 전략 | 사용자 개입 |
|----------|----------|-----------|
| 동일 레코드 동시 수정 | LWW (타임스탬프 기준) | 없음 |
| 삭제 vs 수정 충돌 | 삭제 우선 (tombstone) | 없음 |
| 측정 데이터 중복 | 해시 기반 중복 제거 | 없음 |
| 설정 충돌 (다중 디바이스) | 최신 디바이스 설정 우선 | 선택 UI 표시 |
| 가족 프로필 충돌 | 머지 (비파괴적 합집합) | 충돌 알림 |

---

## 4. 72시간 오프라인 내구성 테스트

### 4.1 테스트 시나리오

| 시나리오 | 조건 | 기대 결과 | 합격 기준 |
|----------|------|----------|----------|
| S1: 기본 오프라인 | 네트워크 끊김 72시간 | 모든 P0 기능 정상 작동 | 100% |
| S2: 대량 측정 축적 | 72시간 × 10회/일 = 720 측정 | 모두 로컬 저장 + 동기화 큐 | 데이터 무손실 |
| S3: 앱 재시작 | 오프라인 중 앱 종료/재시작 5회 | 데이터 무손실 + 상태 복원 | 100% 복원 |
| S4: 동기화 복구 | 72시간 후 온라인 전환 | 전체 데이터 점진적 동기화 | < 5분 (720건) |
| S5: 배터리 방전 복구 | 오프라인 중 배터리 0% → 충전 | 미전송 데이터 보존 | 100% 보존 |
| S6: 저장 공간 부족 | 스토리지 95% 사용 상태 | 캐시 정리 + 측정 계속 가능 | 자동 정리 |
| S7: 다중 디바이스 | 2대 디바이스 각각 오프라인 72시간 | CRDT 머지 무충돌 | 데이터 일관성 |
| S8: 시간대 변경 | 오프라인 중 시간대 변경 | 타임스탬프 일관성 유지 | UTC 기준 |

### 4.2 성능 목표

| 항목 | 목표 | 비고 |
|------|------|------|
| 오프라인 측정 응답 시간 | < 2초 (88채널) | 온라인과 동일 |
| 오프라인 AI 추론 시간 | < 500ms | TFLite 로컬 |
| 동기화 큐 최대 크기 | 10,000건 | SQLite 기반 |
| 동기화 복구 처리량 | > 200건/초 | gRPC 스트리밍 |
| 오프라인 배터리 소모 | < 5%/시간 | BLE 연결 시 |
| 앱 시작 시간 (오프라인) | < 3초 | 캐시 로드 포함 |

---

## 5. 오프라인 보안

### 5.1 오프라인 보안 조치

| 위협 | 대응 | 구현 |
|------|------|------|
| 로컬 DB 탈취 | SQLCipher 암호화 | AES-256-CBC |
| 인증 토큰 만료 | 오프라인 전용 토큰 (7일 유효) | Secure Storage |
| AI 모델 변조 | 모델 파일 SHA-256 검증 | 앱 시작 시 |
| 측정 데이터 변조 | HMAC-SHA256 서명 | 측정 완료 시 |
| 메모리 덤프 | 민감 데이터 메모리 즉시 제로화 | Rust zeroize crate |

### 5.2 오프라인 인증

```
인증 토큰 계층:
├── Access Token (15분, 온라인 전용)
├── Refresh Token (7일, Secure Storage)
├── Offline Token (7일, 별도 발급)
│   ├── 로컬 측정 허용
│   ├── 데이터 저장 허용
│   ├── 네트워크 요청 불가
│   └── 온라인 복귀 시 재인증 필요
└── Device Token (영구, 기기 바인딩)
    └── 기기 식별 전용
```

---

## 6. 네트워크 상태 감지 및 전환

### 6.1 상태 머신

```
[Online] ──연결 끊김──→ [Degraded] ──30초 타임아웃──→ [Offline]
   ↑                                                      │
   └──────────────── 연결 복구 ────────────────────────────┘

각 상태별 동작:
- Online: 실시간 동기화 + 모든 기능
- Degraded: 동기화 큐잉 + 로컬 우선 + 연결 재시도
- Offline: 완전 로컬 모드 + CRDT 큐 적재
```

### 6.2 오프라인 전환 시 자동 동작

1. 미전송 요청 큐잉 (CRDT 큐)
2. 오프라인 토큰 활성화
3. 캐시 모드 전환 (네트워크 요청 차단)
4. 사용자 알림 ("오프라인 모드 전환")
5. 동기화 재시도 백그라운드 스케줄링

### 6.3 온라인 복귀 시 자동 동작

1. 인증 토큰 갱신
2. VectorClock 비교
3. 우선순위 기반 점진적 동기화
4. AI 모델 업데이트 확인 (백그라운드)
5. 카트리지 레지스트리 동기화
6. Push 알림 재등록

---

## 7. 오프라인 지원 아키텍처

```
┌──────────────────────────────────────────────┐
│                 Flutter App                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ UI Layer │  │ BLoC/    │  │ Offline  │  │
│  │          │  │ Cubit    │  │ Manager  │  │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  │
│       │              │              │         │
│  ┌────┴──────────────┴──────────────┴─────┐  │
│  │         Repository Layer               │  │
│  │  ┌──────────┐  ┌──────────────────┐   │  │
│  │  │ Remote   │  │ Local (SQLite/   │   │  │
│  │  │ DataSrc  │  │ Sled/SharedPref) │   │  │
│  │  └────┬─────┘  └────────┬─────────┘   │  │
│  └───────┼──────────────────┼─────────────┘  │
│          │                  │                 │
│  ┌───────┴──────────────────┴─────────────┐  │
│  │       Sync Engine (CRDT)               │  │
│  │  GCounter | LWWRegister | ORSet        │  │
│  │  VectorClock | DeltaSync               │  │
│  └────────────────────────────────────────┘  │
│                                              │
│  ┌────────────────────────────────────────┐  │
│  │       Rust Core (FFI Bridge)           │  │
│  │  BLE | NFC | DSP | Differential | AI  │  │
│  │  Crypto | Sync | Fingerprint          │  │
│  └────────────────────────────────────────┘  │
└──────────────────────────────────────────────┘
```

---

**참조**: 원본 기획안 5.8, 4.3, `rust-core/manpasik-engine/src/sync/`, `QUALITY_GATES.md`
