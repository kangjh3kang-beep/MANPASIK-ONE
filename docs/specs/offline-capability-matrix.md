# 오프라인 기능 매트릭스

**문서번호**: MPK-SPEC-OFFLINE-v1.0  
**기준**: 원본 기획안 5.8 오프라인 완전 구동 시스템  
**목적**: 기능별 온라인/오프라인 지원 여부 및 구현 방식의 공식 기준

---

## 1. 기능 매트릭스

| 기능 | 온라인 | 오프라인 | 구현 방식 |
|------|--------|----------|-----------|
| 리더기 연결 (BLE) | O | O | 로컬 BLE 스택 (btleplug) |
| 카트리지 인식 (NFC) | O | O | 로컬 NFC 검증 (nfc 모듈) |
| 차동 측정 실행 | O | O | Rust 엔진 로컬 처리 (differential) |
| AI 분석 (기본) | O | O | TFLite 로컬 모델 (ai 모듈) |
| AI 분석 (고급) | O | 제한 | LLM·클라우드 추론은 온라인 필요 |
| 건강 기록 조회 | O | O | SQLite/Sled 로컬 DB |
| 음식 사진 분석 | O | O | 로컬 YOLO(또는 동등) 모델 (Phase 2) |
| 건강 리포트 생성 | O | O | 로컬 템플릿 엔진 |
| 데이터 시각화 | O | O | FL Chart 로컬 렌더 |
| 알림 (로컬) | O | O | 로컬 알림 스케줄러 |
| 화상진료 | O | X | WebRTC 온라인 필요 |
| 커뮤니티 | O | 캐시 | 최근 게시물 캐시만 오프라인 |
| 쇼핑/결제 | O | 장바구니 | 장바구니만 로컬, 결제는 온라인 |
| 데이터 동기화 | O | 대기열 | CRDT 큐 적재 (sync 모듈) |
| 펌웨어 업데이트 | O | X | OTA 온라인 필요 |

---

## 2. 오프라인 데이터 저장 구조 (원본 5.8 반영)

| 저장소 | 용도 |
|--------|------|
| SQLite | 구조화 데이터: 측정 결과, 사용자 프로필, 설정 |
| Sled (KV) | AI 모델 캐시, 핑거프린트 벡터, 세션 데이터 |
| 파일 시스템 | AI 모델 파일, 카트리지 보정 데이터, 미디어 캐시 |

---

## 3. 동기화 복구 시 (원본 4.3 반영)

- **동기화 엔진**: CRDT (GCounter, LWWRegister, ORSet). `sync` 모듈.
- **동작**: 오프라인 데이터 큐 → 클라우드 업로드; 클라우드 → 로컬 캐시 갱신.
- **충돌 해소**: Last-Write-Wins + 벡터 클록.
- **추가**: AI 모델 업데이트 다운로드, 연합학습 기여 데이터 전송(온라인 시).

---

**참조**: 원본 기획안 5.8, 4.3, `rust-core/manpasik-engine/src/sync/`, `QUALITY_GATES.md`
