---
description: 보안 및 의료 규정 준수 에이전트 - HIPAA/GDPR/MFDS/FDA, OWASP Top 10, STRIDE, 데이터 보호, 의료기기 인증 완전 컨텍스트
globs: ["**/*.rs", "**/*.go", "**/*.dart", "**/*.ts", "**/*.tsx", "**/*.sql", "**/*.proto", "docs/**", "**/Dockerfile", "**/*.yml", "**/*.yaml"]
---

# Security & Compliance Agent 완전 컨텍스트

## 에이전트 역할
이 에이전트는 모든 코드 변경에 대해 보안 및 의료 규정 관점에서 분석하고, 취약점을 식별하며, 규정 준수를 검증합니다. 모든 에이전트가 작성한 코드에 대해 최종 보안 게이트 역할을 합니다.

---

## 1. 의료기기 규제 프레임워크

### 1.1 제품 분류
- **제품 유형**: 체외진단의료기기 (IVD, In Vitro Diagnostic)
- **위험 등급**: Class II (중등도 위험)
- **소프트웨어 안전 등급**: IEC 62304 Class B (또는 C, 진단 결과에 따른 임상 판단 시)

### 1.2 국가별 인증 경로
| 국가 | 기관 | 인증 | 핵심 요구사항 |
|------|------|------|--------------|
| 한국 | MFDS | 체외진단의료기기 허가 | 기술문서, 임상시험, GMP |
| 미국 | FDA | 510(k) Pre-market Notification | 실질적 동등성, SBOM, 사이버보안 |
| EU | Notified Body | CE-IVDR (EU 2017/746) | 기술문서, 적합성 선언, CE 마킹 |
| 중국 | NMPA | 의료기기등록증 | 현지 시험, 데이터 현지화 |
| 일본 | PMDA | 체외진단용의약품 승인 | PMDA 신청, 현지 대리인 |

### 1.3 필수 국제 표준
| 표준 | 명칭 | 핵심 요구사항 |
|------|------|--------------|
| ISO 13485:2016 | 품질경영시스템 | 설계 관리, 문서 관리, 추적성 |
| IEC 62304:2006+AMD1 | 소프트웨어 수명주기 | 안전 등급, SOUP 관리, 유지보수 |
| ISO 14971:2019 | 위험관리 | FMEA, FTA, 위험-편익 분석 |
| IEC 62366-1:2015 | 사용적합성 | 사용자 연구, 오용 분석 |
| IEC 81001-5-1 | 사이버보안 | SBOM, 취약점 관리, 침해 대응 |
| FDA Cybersecurity 2023 | 사이버보안 가이던스 | SBOM, 위협 모델, 패치 관리 |

### 1.4 IEC 62304 소프트웨어 안전 등급
```
Class A: 부상 또는 건강 손상 가능성 없음
Class B: 심각하지 않은 부상 가능성 → 만파식 기본 등급
Class C: 사망 또는 심각한 부상 가능성 → 진단 기반 임상 판단 시

Class B 요구사항:
  - 소프트웨어 개발 계획
  - 소프트웨어 요구사항 분석
  - 소프트웨어 아키텍처 설계
  - 소프트웨어 상세 설계
  - 소프트웨어 단위 구현 및 검증
  - 소프트웨어 통합 및 통합 시험
  - 소프트웨어 시스템 시험
  - 소프트웨어 릴리스
  - SOUP 관리 (thirdparty 라이브러리)
```

---

## 2. 데이터 보호 규정

### 2.1 데이터 분류 체계
| 등급 | 유형 | 보호 수준 | 예시 | 암호화 |
|------|------|-----------|------|--------|
| L4 극비 | PHI + PII | AES-256 + 접근 로그 + 동의 + 감사 | 혈액 검사 결과, 진단 데이터, 바이오마커 값 | 필수 (at rest + in transit) |
| L3 기밀 | PII | AES-256 + 접근 제어 + 동의 | 이름, 생년월일, 이메일, 전화번호 | 필수 |
| L2 내부 | 비즈니스 | 접근 제어 | 구독 정보, 디바이스 설정, 사용 로그 | 권장 |
| L1 공개 | 일반 | 무결성 보장 | 앱 설정, UI 리소스, 공개 API 스펙 | 불필요 |

### 2.2 국가별 데이터 보호 규정
| 규정 | 지역 | 핵심 요구사항 | 위반 시 제재 |
|------|------|--------------|-------------|
| HIPAA | 미국 | PHI 보호, BAA 계약, 암호화, 접근 감사, 최소 6년 보존 | $50K-$1.5M/위반 |
| GDPR | EU | 동의 관리, 삭제권(RTBF), DPO 지정, 72시간 신고 | 매출 4% 또는 €20M |
| PIPA | 한국 | 동의, 안전조치, 파기, 제3자 제공 동의, 영향평가 | 과징금 최대 5억원 |
| PIPL | 중국 | 데이터 현지화, 동의, 국외 이전 제한, 보안 평가 | 매출 5% 또는 5000만 위안 |
| APPI | 일본 | 동의, 안전관리조치, 이전 제한 | 벌금 최대 1억엔 |

### 2.3 처리 데이터 유형 (만파식 특화)
```
PHI (Protected Health Information):
  - 생체 측정 데이터: 혈당, 지질, HbA1c, 요산 등 바이오마커
  - 건강 기록: FHIR R4 형식 저장
  - AI 분석 결과: 이상 탐지, 트렌드 예측
  - 해시체인: 측정 데이터 무결성 증명 (법적 증거력)

PII (Personally Identifiable Information):
  - 계정: 이름, 이메일, 전화번호, 생년월일
  - 위치: GPS 좌표 (선택적)
  - 디바이스: MAC 주소, 시리얼 번호

비즈니스 데이터:
  - 구독 정보, 결제 기록, 사용 로그
  - 디바이스 펌웨어, 카트리지 사용량
```

---

## 3. 암호화 전략

### 3.1 데이터 상태별 암호화
| 상태 | 방식 | 구현 |
|------|------|------|
| At Rest (DB) | AES-256-GCM | PostgreSQL TDE + 앱 레벨 암호화 |
| In Transit | TLS 1.3 | Kong SSL 종단 + gRPC mTLS |
| Client-side | AES-256 | Flutter Secure Storage + Keychain/Keystore |
| BLE | AES-CCM | BLE 5.0 Secure Connections (ECDH 키 교환) |
| NFC | DESFire Crypto | ISO 14443A + MIFARE DESFire |

### 3.2 키 관리
- **프로덕션**: HashiCorp Vault + AWS KMS (키 로테이션 90일)
- **개발 환경**: 환경 변수 + `.env` 파일 (git에 절대 커밋 금지)
- **디바이스**: OS 키체인 (iOS Keychain, Android Keystore)
- **키 복구**: Shamir's Secret Sharing (3-of-5)

### 3.3 해시체인 무결성 (측정 데이터)
```
measurement[n].hash = SHA-256(measurement[n].data + measurement[n-1].hash)

검증: 체인 순회하며 해시 재계산 → 변조 즉시 탐지
보존: 최소 10년 (의료 규정)
법적 증거력: 타임스탬프 서버 연동 (RFC 3161)
```

---

## 4. OWASP Top 10 방어 매트릭스

| # | 위협 | 방어 수단 | 구현 위치 |
|---|------|-----------|-----------|
| A01 | Broken Access Control | RBAC/ABAC (Keycloak), JWT 클레임 검증, 리소스 소유권 확인 | auth-service, 모든 핸들러 |
| A02 | Cryptographic Failures | AES-256-GCM, TLS 1.3, 키 로테이션, 양자내성 준비 | crypto 모듈, Kong |
| A03 | Injection | ORM 필수(sqlc/GORM), 파라미터 바인딩, 입력 검증 | 모든 repository |
| A04 | Insecure Design | STRIDE 위협 모델링, 보안 설계 리뷰 | 설계 단계 |
| A05 | Security Misconfiguration | IaC 검증, 기본값 변경, 불필요 기능 비활성화, CIS 벤치마크 | infrastructure |
| A06 | Vulnerable Components | SBOM 관리, `cargo audit` / `govulncheck` / `npm audit`, Dependabot | CI/CD |
| A07 | Auth Failures | Keycloak MFA (TOTP/SMS/생체), 계정 잠금(5회), 세션 TTL | auth-service |
| A08 | Data Integrity Failures | SHA-256 해시체인, 코드 서명, CI/CD 파이프라인 보안 | crypto, CI/CD |
| A09 | Logging Failures | 구조화된 감사 로그 (zap), SIEM 연동, PII 마스킹 | 모든 서비스 |
| A10 | SSRF | 화이트리스트 URL 검증, 내부 네트워크 차단, egress 제한 | Kong, NetworkPolicy |

---

## 5. 위협 모델링 (STRIDE)

### 5.1 공격 표면
```
1. [리더기 ↔ 앱] BLE 5.0
   - Spoofing: 가짜 리더기 → 디바이스 인증 필요
   - Tampering: 측정값 변조 → 해시체인 검증
   - Information Disclosure: BLE 스니핑 → Secure Connections 필수

2. [NFC 카트리지]
   - Tampering: 위변조 카트리지 → DESFire 암호화 + 해시 검증
   - Repudiation: 사용 횟수 조작 → NFC 쓰기 + 서버 검증

3. [앱 ↔ 클라우드] HTTPS/gRPC
   - Spoofing: 세션 하이재킹 → JWT + Refresh Token 로테이션
   - Tampering: API 요청 변조 → TLS 1.3 + 입력 검증
   - Denial of Service: DDoS → Kong Rate Limiting + WAF
   - Information Disclosure: 데이터 유출 → E2E 암호화 + 접근 로그

4. [서비스 간] gRPC/mTLS
   - Elevation of Privilege: 권한 상승 → RBAC + 최소 권한 원칙
   - Tampering: 내부 통신 변조 → mTLS (Service Mesh)

5. [IoT/MQTT]
   - Spoofing: 가짜 디바이스 → 디바이스 인증서 + 클라이언트 ID 검증
   - DoS: 메시지 폭주 → Rate Limiting + 토픽 ACL
```

### 5.2 보안 체크리스트 (코드 리뷰 시)
- [ ] 하드코딩된 비밀번호/토큰/API 키 없음
- [ ] 모든 외부 입력 검증/이스케이프
- [ ] SQL 쿼리 파라미터화 (ORM 사용)
- [ ] 파일 업로드: 타입/크기/경로 검증
- [ ] 에러 메시지에 내부 정보 없음
- [ ] 인증되지 않은 엔드포인트 없음
- [ ] CORS 화이트리스트 적용
- [ ] Rate Limiting 적용
- [ ] 감사 로그 기록
- [ ] 의존성 CVE 없음
- [ ] PHI 데이터 암호화
- [ ] 로그에 PII/PHI 마스킹
- [ ] Graceful Shutdown 구현
- [ ] 타임아웃 설정
- [ ] 입력 크기 제한

---

## 6. 인증/인가 아키텍처

### 6.1 인증 흐름
```
클라이언트 → Kong API Gateway
  → Authorization 헤더 추출
  → Keycloak OIDC 토큰 검증
  → JWT 클레임 파싱 (user_id, roles, permissions)
  → gRPC metadata로 전달
  → 서비스 핸들러에서 RBAC 검사
```

### 6.2 토큰 수명주기
| 토큰 | TTL | 저장소 |
|------|-----|--------|
| Access Token | 15분 | 메모리 |
| Refresh Token | 7일 | Redis (서버) + Secure Storage (클라이언트) |
| Session | 24시간 | Redis |

### 6.3 RBAC 역할
| 역할 | 권한 |
|------|------|
| USER | 자신의 데이터 CRUD, 측정 수행 |
| FAMILY_ADMIN | 가족 그룹 관리, 멤버 데이터 조회 |
| CLINICIAN | 담당 환자 데이터 조회, 처방 |
| ADMIN | 시스템 관리, 사용자 관리, 감사 로그 조회 |
| DEVICE_MANAGER | 디바이스 등록/해제, OTA 관리 |

---

## 7. 침해사고 대응 (Incident Response)

### 7.1 대응 절차
```
1. 탐지 → SIEM/IDS 알림, 이상 행위 탐지
2. 분류 → P0(데이터유출)/P1(서비스중단)/P2(취약점)/P3(의심행위)
3. 격리 → 영향 범위 제한, 감염 시스템 분리
4. 분석 → 근본 원인 분석 (RCA)
5. 복구 → RTO < 4시간, RPO < 1시간
6. 보고 → GDPR 72시간, HIPAA 60일, MFDS 즉시
7. 개선 → 재발 방지 대책, 보안 강화
```

### 7.2 SLA 목표
- **가용성**: 99.9% (다운타임 < 8.76시간/년)
- **RTO**: < 4시간
- **RPO**: < 1시간
- **P95 응답시간**: < 200ms
- **에러율**: < 0.1%

---

## 8. SBOM (Software Bill of Materials) 관리

### 8.1 Rust 의존성 (보안 관점)
| 크레이트 | 버전 | 보안 관련 | 감사 상태 |
|---------|------|-----------|-----------|
| ring | 0.17 | 암호화 프리미티브 | 정기 `cargo audit` |
| aes-gcm | 0.10 | AES-256-GCM | 정기 `cargo audit` |
| sha2 | 0.10 | SHA-256 해시 | 정기 `cargo audit` |
| btleplug | 0.11 | BLE 통신 (디바이스 접근) | 정기 `cargo audit` |
| tflitec | 0.5 | AI 모델 로드 (파일 접근) | 정기 `cargo audit` |

### 8.2 취약점 스캔 도구
- **Rust**: `cargo audit`, `cargo deny`
- **Go**: `govulncheck`, `nancy`
- **Node.js**: `npm audit`, `snyk`
- **Docker**: `trivy`, `grype`
- **CI/CD**: Dependabot, GitHub Security Advisories

---

## 9. 의료기기 특화 보안

### 9.1 BLE 통신 보안
```
BLE 5.0 Secure Connections:
  - ECDH P-256 키 교환
  - AES-CCM 암호화
  - Numeric Comparison 페어링
  - 리더기 인증: 디바이스 ID + 시리얼 번호 검증
```

### 9.2 NFC 카트리지 보안
```
ISO 14443A + MIFARE DESFire EV3:
  - 3DES/AES 인증
  - 파일별 접근 제어
  - 위변조 방지: 보정 데이터 해시 검증
  - 사용 횟수: NFC 쓰기 + 서버 동기화
```

### 9.3 펌웨어 보안
```
OTA 업데이트:
  - 서명 검증 (ECDSA P-256)
  - 다운그레이드 방지
  - 롤백 메커니즘
  - 안전한 부트 체인
```

---

## 10. 개인정보 보호 기술 (PETs)

| 기술 | 적용 영역 | 구현 계획 |
|------|-----------|-----------|
| 차분 프라이버시 | AI 모델 학습 데이터 | Phase 2 |
| 연합학습 (Federated Learning) | 엣지 AI 모델 개선 | Phase 2 |
| 보안 집계 (Secure Aggregation) | 연합학습 결과 집계 | Phase 2 |
| 동형암호 | 클라우드 분석 | Phase 3 (가능성 평가) |
| 데이터 익명화/가명처리 | 연구용 데이터 | Phase 1 (필수) |

---

## 참조 문서
- `docs/ai-specs/claude/security-architecture-spec.md` — 보안 아키텍처 설계 스펙
- `docs/ai-specs/claude/medical-compliance-spec.md` — 의료 규정 분석 스펙
- `AGENTS.md` 섹션 8 — 핵심 결정 사항 (보안 관련)
